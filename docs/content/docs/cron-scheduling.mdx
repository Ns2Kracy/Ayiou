---
title: 调度器与 Cron
description: 内置 Scheduler trait 与默认 TokioScheduler
---

Ayiou 现在内置了完整 runtime 调度抽象：

- `Scheduler` trait
- 默认实现 `TokioScheduler`
- 支持：`schedule_once`、`schedule_interval`、`schedule_cron`、`cancel`、`shutdown`

## 快速示例

```rust
use ayiou::prelude::*;
use std::{sync::Arc, time::Duration};

#[tokio::main]
async fn main() -> anyhow::Result<()> {
    let scheduler: Arc<dyn Scheduler> = Arc::new(TokioScheduler::new());

    // 一次性任务
    scheduler.schedule_once(
        Duration::from_secs(1),
        schedule_job(|| async {
            println!("run once");
        }),
    )?;

    // 周期任务
    let tick_id = scheduler.schedule_interval(
        Duration::from_secs(5),
        schedule_job(|| async {
            println!("tick");
        }),
    )?;

    // Cron 任务（每分钟）
    scheduler.schedule_cron(
        "0 * * * * *",
        schedule_job(|| async {
            println!("cron fired");
        }),
    )?;

    tokio::time::sleep(Duration::from_secs(12)).await;
    let _ = scheduler.cancel(tick_id).await?;
    scheduler.shutdown().await?;

    Ok(())
}
```

## 与 Bot 运行时集成

`Bot` 支持注入 scheduler：

```rust
let scheduler: Arc<dyn Scheduler> = Arc::new(TokioScheduler::new());
let bot = Bot::<OneBotV11Adapter>::new().with_scheduler(scheduler);
```

在收到 Ctrl+C 退出时，`Bot` 会自动调用 `scheduler.shutdown()`。

## 设计建议

- 长流程插件：每步状态写入 `SessionStore`，超时检查交给 `schedule_once`
- 业务轮询：用 `schedule_interval`
- 固定时间点任务：用 `schedule_cron`
